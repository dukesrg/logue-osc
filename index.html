<html>
<head>
<style>
  * {
    background-color: #111;
    color: #fff;
    font-family: sans-serif;
  }
  *[disabled] {
    color: #777;
  }
  table {
    border-color: #111;
  }
  th {
    font-size: small;
  }
  td, th {
    text-align: left;
  }
  td:first-of-type {
    color: #777;
  }
  td {
    background-color: #000;
  }
  input {
    border: 0;
  }
  input[type="button"] {
    background: linear-gradient(to top, #222, #444);
    border-radius: 2px;
  }
  input[type="button"]:disabled {
    background: linear-gradient(to top, #111, #111);
  }
  input[type="radio"] {
    display: none;
  }
  input[type="radio"]:checked + img {
    background: linear-gradient(to top, #222, #222);
  }
  img {
    background: linear-gradient(to top, #222, #444);
    border-radius: 2px;
    padding: 6px;
  }
</style>
<script type="text/javascript" src="jszip.js"></script>
<script type="text/javascript" src="FileSaver.js"></script>
<script language="javascript">
"use strict";
var data;

function inject(osc) {
  var type = document.querySelector('input[name=type]:checked').id + "unit";
  var name = document.querySelector('input[type=text][name=' + osc.name + ']').value;
  fetch(osc.name + "-osc." + type)
  .then((response) => {
    if (response.status === 200 || response.status === 0) {
        return Promise.resolve(response.blob());
    } else {
        return Promise.reject(new Error(response.statusText));
    }
  })
  .then(JSZip.loadAsync)
  .then((zip) => {
    var manifest;
    var payload;
    Promise.all([
      zip.file(osc.name + "/payload.bin").async("Uint8Array").then((text) => {
        payload = text;
        var offs = 0x40;
        for (var i = 0; i < data.length && i < 4; i++) {
          for (var j = 0; j < data[i].length; j++) {
            payload[offs++] = data[i][j];
          }
        }
      }),
      zip.file(osc.name + "/manifest.json").async("string").then((data) => {
        manifest = JSON.parse(data);
        manifest.header.name = name.substring(0, 12);
        manifest = JSON.stringify(manifest, null, "  ");
      })
    ]).then(values => { 
      zip = new JSZip();
      zip.file(osc.name + "/payload.bin", payload);
      zip.file(osc.name + "/manifest.json", manifest);
      zip.generateAsync({type:"blob"}).then((blob) => saveAs(blob, osc.name + "-" + name + "." + type));
    });
  })
}

function getInfo(osc) {
  var type = document.querySelector('input[name=type]:checked').id + "unit";
  fetch(osc + "-osc." + type)
  .then((response) => {
    if (response.status === 200 || response.status === 0) {
        return Promise.resolve(response.blob());
    } else {
        return Promise.reject(new Error(response.statusText));
    }
  })
  .then(JSZip.loadAsync)
  .then((zip) => {
    zip.file(osc + "/manifest.json").async("string").then((data) => {
      var manifest = JSON.parse(data);
      ["version", "api"].map(e => document.querySelector("td[id=" + osc + "-" + e).innerHTML = manifest.header[e]);
    })
  })
}

function pcm16toulaw(val) {
  var mask;
  var seg;
  var t = 0x7FFF;

  if (val > t) {
    val = 0x8000 - (val & 0x7FFF);
    mask = 0x7F;
  } else
    mask = 0xFF;

  val += 0x84;

  for (seg = 8; seg > 0; seg--) {
    if (val > t)
      break;
    t = t >> 1;
  }

  if (seg == 8)
    return (0x7F ^ mask);
  else {
    val = (seg << 4) | ((val >> (seg + 3)) & 0x0F);
    return (val ^ mask);
  }
}

function handleFiles(f) {
  var files = f.files;
  var status = document.querySelector('#status');
  var osc = f.name;
  var name = document.querySelector('input[type=text][name=' + osc + ']');
  name.value = "";
  data = new Array();
  status.innerHTML = "";
  for (var i = 0; i < files.length; i++) {
    var reader = new FileReader();
    reader.onload = (event) => {
      status.innerHTML += event.target.filename + ": ";
      var array = new Uint8Array(event.target.result);
      if (osc === "FM64") {
        if (array.length > 4104) {
           status.innerHTML += "skipped (size mismatch)";
        } else {
          if (data.length >= 4) {
            status.innerHTML += "skipped (maximum voice bank limit reached)";
          } else {
            if (array.length == 4096) {
              status.innerHTML += "added (assuming raw voice bank)";
              name.value += event.target.filename.substring(0, event.target.filename.lastIndexOf("."));
              data.push(array);
            } else {
              switch(array.slice(0, 6).join("")) {
                case "2406709160":
                  status.innerHTML += "ignoring SysEx size mismatch, ";
                case "2406709320":
                  status.innerHTML += "added 6-operators voice bank";
                  name.value += event.target.filename.substring(0, event.target.filename.lastIndexOf("."));
                  data.push(array.slice(6, 4102));
                  break;
                case "2406704160":
                  status.innerHTML += "ignoring SysEx size mismatch, ";
                case "2406704320":
                  status.innerHTML += "added 4-operators voice bank";
                  name.value += event.target.filename.substring(0, event.target.filename.lastIndexOf("."));
                  data.push(array.slice(6, 4102));
                  break;
                default:
                  status.innerHTML += "skipped unsupported SysEx";
              }
            }
          }
        }
      } else {
        if (array.slice(0, 4).join("") + array.slice(8, 12).join("") === "8273707087658669") {
          if (array.slice(22, 24).join("") === "10") {
            switch(array.slice(20, 22).join("") + array.slice(34, 36).join("")) {
              case "10160": //16-bit PCM
                var size = array[0x28] + (array[0x29] << 8) + (array[0x2A] << 16) + (array[0x2B] << 24);
                if (size < 32768) {
                  status.innerHTML += "skipped (samle count too small)";
                } else {
                   status.innerHTML += "added transcoded from 16-bit PCM to &#xb5;-law";
                   if (size > 32768) {
                     status.innerHTML += ", truncated to 16384 samples";
                   }
                   var newarray = new Uint8Array(16384);
                   for (i = 0; i < newarray.length; i++)
                     newarray[i] = pcm16toulaw(array[44 + i * 2] + (array[45 + i * 2] << 8));
                   data.push(newarray);
                   name.value += event.target.filename.substring(0, event.target.filename.lastIndexOf("."));
                }
                break;
              case "7080": //u-Law
                var size = array[0x2E] + (array[0x2F] << 8) + (array[0x30] << 16) + (array[0x31] << 24);
                if (size < 16384) {
                  status.innerHTML += "skipped (samle count too small)";
                } else {
                   status.innerHTML += "added &#xb5;-law compressed file";
                   if (size > 16384) {
                     status.innerHTML += ", truncated to 16384 samples";
                   }
                   name.value += event.target.filename.substring(0, event.target.filename.lastIndexOf("."));
                   data.push(array.slice(58, 16469))
                }
                break;
              default:
                status.innerHTML += "skipped (format not supported)";
            };
          } else {
            status.innerHTML += "skipped (channel count not supported)";
          }
        } else {
          status.innerHTML += "skipped unsupported file format";
        }
      }
      status.innerHTML += "<br/>";
      if (data.length > 0) {
        document.querySelector('input[type=button][name=' + osc + ']').disabled = false;
        name.disabled = false;
      }
    }
    reader.filename = files[i].name;
    reader.readAsArrayBuffer(files[i]);
  }
}

function typeClick(type) {
  document.cookie = "type=" + type.id;
}

function onLoad() {
  var type = document.querySelector('input[id=' + document.cookie.substring(document.cookie.indexOf("type=")).split(";")[0].split("=")[1] + ']')
  if (type)
    type.checked = true;
  ["FM64", "Morpheus"].map(e => getInfo(e));
}

</script>
</head>
<body onload="onLoad();">
<h3>Generate custom oscillators, refer to <a href="https://github.com/dukesrg/logue-osc">https://github.com/dukesrg/logue-osc</a> for details</h3>
<label><input type="radio" id="prlg" name="type" onchange="typeClick(this);"><img src="prlg.png"/></label>
<label><input type="radio" id="mnlgxd" name="type" onchange="typeClick(this);"><img src="mnlgxd.png"/></label>
<label><input type="radio" id="ntkdig" name="type" onchange="typeClick(this);"><img src="ntkdig.png"/></label>
<table cellpadding="6" border="0" width="25%">
<tr><td style="width: 100%; font-size: small; color: #FFF; background-color: #222; text-align: center;">USER OSCILLATORS</td></tr>
</table>
<table rules="rows" cellpadding="6" border="2" width="100%">
<tr><th/><th>NAME</th><th>VERSION</th><th>API</th><th>CUSTOM&nbsp;DATA</th><th>CUSTOM&nbsp;NAME</th><th>DOWNLOAD</th><th/></tr>
<tr><td>1</td><td>FM64</td><td id="FM64-version"/><td id="FM64-api"/><td><input type="file" name="FM64" accept=".syx" multiple="true" onchange="handleFiles(this);"></td><td><input type="text" name="FM64" disabled="true"></td><td><input type="button" name="FM64" value="Download" disabled="true" onClick="inject(this);"/></td><td/></tr>
<tr><td>2</td><td>Morpheus</td><td id="Morpheus-version"/><td id="Morpheus-api"/><td><input type="file" name="Morpheus" accept=".wav" onchange="handleFiles(this);"></td><td><input type="text" name="Morpheus" disabled="true"></td><td><input type="button" name="Morpheus" value="Download" disabled="true" onClick="inject(this);"/></td><td/></tr>
<tr><td>3</td><td>---</td><td>---</td><td>---</td><td>---</td><td>---</td><td>---</td><td/></tr>
<tr><td>4</td><td>---</td><td>---</td><td>---</td><td>---</td><td>---</td><td>---</td><td/></tr>
<tr><td>5</td><td>---</td><td>---</td><td>---</td><td>---</td><td>---</td><td>---</td><td/></tr>
<tr><td>6</td><td>---</td><td>---</td><td>---</td><td>---</td><td>---</td><td>---</td><td/></tr>
<tr><td>7</td><td>---</td><td>---</td><td>---</td><td>---</td><td>---</td><td>---</td><td/></tr>
<tr><td>8</td><td>---</td><td>---</td><td>---</td><td>---</td><td>---</td><td>---</td><td/></tr>
<tr><td>9</td><td>---</td><td>---</td><td>---</td><td>---</td><td>---</td><td>---</td><td/></tr>
<tr><td>10</td><td>---</td><td>---</td><td>---</td><td>---</td><td>---</td><td>---</td><td/></tr>
<tr><td>11</td><td>---</td><td>---</td><td>---</td><td>---</td><td>---</td><td>---</td><td/></tr>
<tr><td>12</td><td>---</td><td>---</td><td>---</td><td>---</td><td>---</td><td>---</td><td/></tr>
<tr><td>13</td><td>---</td><td>---</td><td>---</td><td>---</td><td>---</td><td>---</td><td/></tr>
<tr><td>14</td><td>---</td><td>---</td><td>---</td><td>---</td><td>---</td><td>---</td><td/></tr>
<tr><td>15</td><td>---</td><td>---</td><td>---</td><td>---</td><td>---</td><td>---</td><td/></tr>
<tr><td>16</td><td>---</td><td>---</td><td>---</td><td>---</td><td>---</td><td>---</td><td/></tr>
</table>
<small><div id="status"></div></small>
</body>
</html>
