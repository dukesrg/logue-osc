<html>
<head>
<script type="text/javascript" src="jszip.js"></script>
<script type="text/javascript" src="FileSaver.js"></script>
<script language="javascript">
"use strict";
var data;

function inject() {
  var type = document.querySelector('input[name=type]:checked').value;
  var osc = document.querySelector('input[name=osc]:checked').value;
  var name = document.querySelector('input[id=name]').value;
  fetch(osc + "-osc." + type)
  .then((response) => {
    if (response.status === 200 || response.status === 0) {
        return Promise.resolve(response.blob());
    } else {
        return Promise.reject(new Error(response.statusText));
    }
  })
  .then(JSZip.loadAsync)
  .then((zip) => {
    var manifest;
    var oscname;
    var oscversion;
    var payload;
    Promise.all([
      zip.file(osc + "/payload.bin").async("Uint8Array").then((text) => {
        payload = text;
        var offs = 0x40;
        for (var i = 0; i < data.length && i < 4; i++) {
          for (var j = 0; j < data[i].length; j++) {
            payload[offs++] = data[i][j];
          }
        }
      }),
      zip.file(osc + "/manifest.json").async("string").then((data) => {
        manifest = JSON.parse(data);
        oscname = manifest.header.name;
        oscversion = manifest.header.version;
        manifest.header.name = name.substring(0, 12);
        manifest = JSON.stringify(manifest, null, "  ");
      })
    ]).then(values => { 
      document.querySelector('#status').innerHTML += "Source oscillator: " + oscname + " v." + oscversion;
      zip = new JSZip();
      zip.file(osc + "/payload.bin", payload);
      zip.file(osc + "/manifest.json", manifest);
      zip.generateAsync({type:"blob"}).then((blob) => saveAs(blob, osc + "-" + name + "." + type));
    });
  })
}

function handleFiles(files) {
  var status = document.querySelector('#status');
  var osc = document.querySelector('input[name=osc]:checked').value;
  var name = document.querySelector('input[id=name]');
  name.value = "";
  data = new Array();
  status.innerHTML = "";
  for (var i = 0; i < files.length; i++) {
    var reader = new FileReader();
    reader.onload = (event) => {
      status.innerHTML += event.target.filename + ": ";
      var array = new Uint8Array(event.target.result);
      if (osc === "FM64") {
        if (array.length > 4104) {
           status.innerHTML += "skipped (size mismatch)";
        } else {
          if (data.length >= 4) {
            status.innerHTML += "skipped (maximum voice bank limit reached)";
          } else {
            if (array.length == 4096) {
              status.innerHTML += "added (assuming raw voice bank)";
              name.value += event.target.filename.substring(0, event.target.filename.lastIndexOf("."));
              data.push(array);
            } else {
              switch(array.slice(0, 6).join("")) {
                case "2406709160":
                  status.innerHTML += "ignoring SysEx size mismatch, ";
                case "2406709320":
                  status.innerHTML += "added 6-operators voice bank";
                  name.value += event.target.filename.substring(0, event.target.filename.lastIndexOf("."));
                  data.push(array.slice(6, 4102));
                  break;
                case "2406704160":
                  status.innerHTML += "ignoring SysEx size mismatch, ";
                case "2406704320":
                  status.innerHTML += "added 4-operators voice bank";
                  name.value += event.target.filename.substring(0, event.target.filename.lastIndexOf("."));
                  data.push(array.slice(6, 4102));
                  break;
                default:
                  status.innerHTML += "skipped unsupported SysEx";
              }
            }
          }
        }
      } else {
        if (array.slice(0, 4).join("") + array.slice(8, 12).join("") === "8273707087658669") {
          if (array.slice(22, 24).join("") === "10") {
            switch(array.slice(20, 22).join("") + array.slice(34, 36).join("")) {
              case "7080": //u-Law
                var size = array[0x2E] + (array[0x2F] << 8) + (array[0x30] << 16) + (array[0x31] << 24);
                if (size < 16384) {
                  status.innerHTML += "skipped (samle count too small)";
                } else {
                   status.innerHTML += "added &#xb5;-law compressed file";
                   if (size > 16384) {
                     status.innerHTML += ", truncated to 16384 samples";
                   }
                   name.value += event.target.filename.substring(0, event.target.filename.lastIndexOf("."));
                   data.push(array.slice(58, 16469))
                }
                break;
              default:
                status.innerHTML += "skipped (format not supported)";
            };
          } else {
            status.innerHTML += "skipped (channel count not supported)";
          }
        } else {
          status.innerHTML += "skipped unsupported file format";
        }
      }
      status.innerHTML += "<br/>";
      if (data.length > 0) {
        document.querySelector('input[id=download]').disabled = false;
        name.disabled = false;
      }
    }
    reader.filename = files[i].name;
    reader.readAsArrayBuffer(files[i]);
  }
}

function oscClick(osc) {
  var f = document.querySelector('input[id=files]');
  f.disabled = false;
  if (osc.value === "FM64") {
    f.multiple = true;
    f.accept = ".syx";
  } else {
    f.multiple = false;
    f.accept = ".wav";
  }
  f.value = "";
  handleFiles(f.files);
}
</script>
</head>
<body>
<h3>Generate custom oscillators, refer to <a href="https://github.com/dukesrg/logue-osc">https://github.com/dukesrg/logue-osc</a> for details</h3>
<label>Target synth:</label>
<input type="radio" id="prlgunit" name="type" value="prlgunit" checked="true"><label for="prlgunit">prologue</label>
<input type="radio" id="mnlgxdunit" name="type" value="mnlgxdunit"><label for="mnlgxdunit">minilogue xd</label>
<input type="radio" id="ntkdigunit" name="type" value="ntkdigunit"><label for="ntkdigunit">Nu:Tekt NTS-1 digital kit</label>
<br/>
<label>Source oscillator:</label>
<input type="radio" id="FM64" name="osc" value="FM64" onClick="oscClick(this);"><label for="FM64">FM64</label>
<input type="radio" id="Morpheus" name="osc" value="Morpheus" onClick="oscClick(this);"><label for="Morpheus">Morpheus</label>
<br/>
<label for="files">Custom data:</label><input type="file" name="files" id="files" disabled="true" onchange="handleFiles(this.files);">
<br/><label for="name">Custom name:</label><input type="text" id="name" name="name" disabled="true"><br>
<br/><small><div id="status"></div></small>
<br/><input type="button" id="download" value="Download" disabled="true" onClick="inject();" />
</body>
</html>
